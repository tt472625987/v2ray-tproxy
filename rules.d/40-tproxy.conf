#!/bin/sh
. /home/v2ray-tproxy/config.conf

# 在V2RAY链开头添加
iptables -t mangle -I V2RAY 1 -j LOG --log-prefix "[V2RAY-TRAFFIC] "

# 创建主规则链
iptables -t mangle -N V2RAY 2>/dev/null || true
iptables -t mangle -F V2RAY

# TCP透明代理
iptables -t mangle -A V2RAY -p tcp -m socket -j DIVERT
iptables -t mangle -A V2RAY -p tcp -j TPROXY \
    --tproxy-mark $MARK_VALUE --on-port $TPROXY_PORT

# 取消下面注释启用UDP代理（需要v2ray配置支持）
#iptables -t mangle -A V2RAY -p udp -j TPROXY \
#    --tproxy-mark $MARK_VALUE --on-port $TPROXY_PORT

# 挂载到PREROUTING（插入到第1条）
iptables -t mangle -I PREROUTING 1 -j V2RAY